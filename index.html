<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Buffalos Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://www.youtube.com" crossorigin>
  <link rel="preconnect" href="https://i.ytimg.com" crossorigin>
  <link rel="preconnect" href="https://www.google.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800&display=swap" rel="stylesheet">

  <style>
    :root { --maxw: 1280px; }
    html, body {
      margin:0;
      background:#000;
      color:#fff;
      font-family:"Inter", system-ui, Segoe UI, Roboto, Helvetica, Arial;
    }
    header {
      padding:18px 12px;
      text-align:center;
      font-weight:800;
      letter-spacing:.2px;
      font-size:clamp(20px,3.2vw,28px);
    }
    .wrap {
      max-width:var(--maxw);
      margin:0 auto;
      padding:0 12px 40px;
    }
    .logo {
      max-width:200px;
      height:auto;
      margin:8px auto 18px;
      display:block;
      opacity:.98;
    }
    .player {
      position:relative;
      width:100%;
      max-width:1280px;
      margin:0 auto;
      background:#0c0c0c;
      border-radius:10px;
      overflow:hidden;
    }
    .player iframe {
      width:100% !important;
      height:100% !important;
      aspect-ratio:16/9;
      border:0;
      display:block;
    }
    #offline, #loading {
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:12px;
      text-align:center;
      min-height:50vh;
      background:#0c0c0c;
      border-radius:10px;
      padding:24px;
    }
    #offline h2, #loading h2 { margin:0; font-weight:800 }
    #offline p, #loading p  { margin:0; color:#bbb }
    .hidden { display:none !important }
    .btn {
      display:inline-block;
      padding:10px 14px;
      border-radius:8px;
      background:#0af;
      color:#000;
      font-weight:800;
      text-decoration:none;
    }
    .spinner {
      width:36px;
      height:36px;
      border:4px solid #444;
      border-top:4px solid #0af;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
    .foot { opacity:.7; text-align:center; font-size:12px; margin-top:16px; }
  </style>
</head>
<body>
  <header>Buffalos Live</header>
  <div class="wrap">
    <img src="logo.png" alt="Buffalos Logo" class="logo" onerror="this.style.display='none'"/>

    <!-- Loading -->
    <section id="loading">
      <h2>Buffalos Loading…</h2>
      <div class="spinner" aria-hidden="true"></div>
    </section>

    <!-- Offline -->
    <section id="offline" class="hidden" aria-live="polite">
      <h2>Buffalos are offline</h2>
      <p>Check back later for the next game!</p>
      <p><a class="btn" id="ytBtn" target="_blank" rel="noopener">Watch on YouTube</a></p>
      <div class="foot">This page auto-starts when we go live.</div>
    </section>

    <!-- Player -->
    <section id="youtube-embed" class="player hidden">
      <iframe
        id="live-frame"
        title="Buffalos Live"
        allow="autoplay; encrypted-media; picture-in-picture"
        allowfullscreen
        referrerpolicy="origin-when-cross-origin">
      </iframe>
    </section>
  </div>

  <script>
  // ---- CONFIG ----
  // Keep YouTube for the bottom button exactly as before:
  const CHANNEL_ID = "UCCvYIv25tpMuQuGATwxvMjA";
  const CHANNEL_URL = `https://www.youtube.com/channel/${CHANNEL_ID}`;

  // New: SidelineHD worker + URL
  const TEAM_SLHD   = "HoustonBuffalos10";
  const SIDELINE_URL = `https://sidelinehd.com/${TEAM_SLHD}/live`;
  const WORKER_URL   = "https://buffalosliveapp.wdoggett.workers.dev/slhd?team=" + TEAM_SLHD;

  const POLL_MS = 7000; // same cadence you had

  // ---- ELEMENTS ----
  const loadingDiv = document.getElementById("loading");
  const offlineDiv = document.getElementById("offline");
  const playerDiv  = document.getElementById("youtube-embed"); // reuse the same container
  const liveFrame  = document.getElementById("live-frame");
  const ytBtn      = document.getElementById("ytBtn");
  ytBtn.textContent = "Watch on YouTube"; // keep label
  ytBtn.href        = CHANNEL_URL;        // keep pointing to YouTube

  function show(el){ el.classList.remove("hidden"); }
  function hide(el){ el.classList.add("hidden"); }
  function showLoad(){ show(loadingDiv); hide(playerDiv); hide(offlineDiv); }
  function showLive(){ hide(loadingDiv); hide(offlineDiv); show(playerDiv); }
  function showOff(){ hide(loadingDiv); hide(playerDiv); show(offlineDiv); }

  // ---- LOGIC ----
  let pollTimer = null;
  let isLiveNow = false;

  async function checkLiveOnce(){
    try {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort("timeout"), 8000);
      const res = await fetch(WORKER_URL, { cache: "no-store", signal: ctrl.signal });
      clearTimeout(t);

      if (!res.ok) throw new Error("worker " + res.status);
      const data = await res.json();

      if (data?.live === true) {
        // Only (re)load when we flip to live or src isn't set yet
        if (!isLiveNow || !liveFrame.src || !liveFrame.src.startsWith(SIDELINE_URL)) {
          liveFrame.removeAttribute("srcdoc"); // in case a browser cached a prior srcdoc
          liveFrame.src = SIDELINE_URL;        // embed SidelineHD live page
        }
        isLiveNow = true;
        showLive();
      } else {
        isLiveNow = false;
        showOff();
      }
    } catch (e) {
      // On error, don’t flip to loading forever—just show Offline with the YouTube button
      if (!isLiveNow) showOff();
    }
  }

  function startPolling(){
    stopPolling();
    pollTimer = setInterval(() => {
      if (!document.hidden) checkLiveOnce();
    }, POLL_MS);
  }
  function stopPolling(){ if (pollTimer) clearInterval(pollTimer); pollTimer = null; }

  // Wake checks when page regains attention or network returns
  document.addEventListener("visibilitychange", () => { if (!document.hidden) checkLiveOnce(); });
  window.addEventListener("focus", checkLiveOnce);
  window.addEventListener("online", checkLiveOnce);

  // Boot
  showLoad();
  checkLiveOnce();
  startPolling();
  // If nothing determined after 10s, show Offline w/ YouTube button
  setTimeout(() => { if (!isLiveNow) showOff(); }, 10000);
</script>
